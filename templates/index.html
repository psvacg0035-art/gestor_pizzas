<!DOCTYPE html>
<html>
<head>
    <title>Gestor de Pizzas</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
</head>

<body class="bg-light">

<div class="container mt-4">

<h2 class="text-center">üçï Gesti√≥n de Ventas - {{ fecha_hoy }}</h2>

<hr>

<h4>‚ûï Nuevo Pedido</h4>

<form action="/agregar" method="POST" class="row g-3">

<div class="col-md-4">
<input class="form-control" name="cliente" placeholder="Cliente" required>
</div>

<div class="col-md-4">
<input class="form-control" name="departamento" placeholder="Departamento" required>
</div>

<div class="col-md-4">
<input class="form-control" name="telefono" placeholder="Tel√©fono">
</div>

<div class="col-md-4">
<input class="form-control" name="sabor" placeholder="Sabor" required>
</div>

<div class="col-md-2">
<input class="form-control" type="number" name="cantidad" placeholder="Cantidad" required>
</div>

<div class="col-md-2">
<input class="form-control" type="number" name="precio" placeholder="Precio" required>
</div>

<div class="col-md-4">
<input class="form-control" type="time" name="hora" required>
</div>

<div class="col-md-12">
<input class="form-control" name="observaciones" placeholder="Observaciones">
</div>

<div class="col-12">
<button class="btn btn-success">Guardar</button>
</div>

</form>

<hr>

<h4>üü° Pedidos Activos</h4>

<table class="table table-bordered text-center align-middle">
<tr>
<th>Hora</th>
<th>Cliente</th>
<th>Sabor</th>
<th>Observaciones</th>
<th>Total</th>
<th>Acci√≥n</th>
</tr>

{% for p in pedidos_activos %}
<tr>
<td>{{ p.hora_entrega }}</td>
<td>{{ p.cliente }}</td>
<td>{{ p.sabor }}</td>
<td>{{ p.observaciones }}</td>
<td>${{ "{:,.0f}".format(p.total).replace(",", ".") }}</td>
<td>
<button class="btn btn-success btn-sm"
        data-bs-toggle="modal"
        data-bs-target="#modalPago"
        onclick="abrirModal({{ p.id }}, {{ p.total }})">
Entregar
</button>
</td>
</tr>
{% endfor %}
</table>

<h4 class="mt-5">üü¢ Entregados</h4>

<table class="table table-bordered text-center align-middle">
<tr>
<th>Hora</th>
<th>Cliente</th>
<th>Sabor</th>
<th>Observaciones</th>
<th>M√©todo Pago</th>
<th>Total</th>
</tr>

{% for p in pedidos_entregados %}
<tr>
<td>{{ p.hora_entrega }}</td>
<td>{{ p.cliente }}</td>
<td>{{ p.sabor }}</td>
<td>{{ p.observaciones }}</td>
<td>{{ p.metodo_pago }}</td>
<td>${{ "{:,.0f}".format(p.total).replace(",", ".") }}</td>
</tr>
{% endfor %}
</table>

</div>

<!-- MODAL PROFESIONAL -->
<div class="modal fade" id="modalPago" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">

      <div class="modal-header">
        <h5 class="modal-title">Confirmar Entrega</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>

      <div class="modal-body">

        <p><strong>Total:</strong> $<span id="modalTotal"></span></p>

        <div class="d-grid gap-2 mb-3">
          <button class="btn btn-outline-success" onclick="seleccionarPago('Efectivo')">
            üíµ Efectivo
          </button>

          <button class="btn btn-outline-primary" onclick="seleccionarPago('Transferencia')">
            üè¶ Transferencia
          </button>
        </div>

        <div id="seccionEfectivo" style="display:none;">
          <input type="number"
                 id="efectivoRecibido"
                 class="form-control mb-2"
                 placeholder="Efectivo recibido"
                 oninput="calcularVuelto()">

          <p><strong>Vuelto:</strong> $<span id="vueltoCalculado">0</span></p>
        </div>

        <div id="errorPago" class="text-danger" style="display:none;">
          Debes seleccionar un m√©todo de pago.
        </div>

      </div>

      <div class="modal-footer">
        <button class="btn btn-success" onclick="confirmarEntrega()">
          Confirmar Entrega
        </button>
      </div>

    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

<script>
let pedidoActual = null;
let totalActual = 0;
let metodoSeleccionado = "";

function abrirModal(id, total){
    pedidoActual = id;
    totalActual = total;
    metodoSeleccionado = "";
    document.getElementById("modalTotal").innerText = total;
    document.getElementById("seccionEfectivo").style.display = "none";
    document.getElementById("errorPago").style.display = "none";
    document.getElementById("efectivoRecibido").value = "";
    document.getElementById("vueltoCalculado").innerText = "0";
}

function seleccionarPago(metodo){
    metodoSeleccionado = metodo;
    document.getElementById("errorPago").style.display = "none";

    if(metodo === "Efectivo"){
        document.getElementById("seccionEfectivo").style.display = "block";
    } else {
        document.getElementById("seccionEfectivo").style.display = "none";
    }
}

function calcularVuelto(){
    let recibido = parseInt(document.getElementById("efectivoRecibido").value) || 0;
    let vuelto = recibido - totalActual;
    document.getElementById("vueltoCalculado").innerText = vuelto > 0 ? vuelto : 0;
}

function confirmarEntrega(){
    if(!metodoSeleccionado){
        document.getElementById("errorPago").style.display = "block";
        return;
    }
    window.location.href = "/entregar/" + pedidoActual + "?metodo=" + metodoSeleccionado;
}
</script>

</body>
</html>
