<!DOCTYPE html>
<html>
<head>
    <title>Gestor de Pizzas</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
</head>

<body class="bg-light">

<div class="container mt-4">

<h2 class="text-center">üçï Gesti√≥n de Ventas - {{ fecha_hoy }}</h2>

<hr>

<h4>‚ûï Nuevo Pedido</h4>

<form action="/agregar" method="POST" class="row g-3">

<div class="col-md-4">
<input class="form-control" name="cliente" placeholder="Cliente" required>
</div>

<div class="col-md-4">
<input class="form-control" name="departamento" placeholder="Departamento" required>
</div>

<div class="col-md-4">
<input class="form-control" name="telefono" placeholder="Tel√©fono">
</div>

<div class="col-md-4">
<input class="form-control" name="sabor" placeholder="Sabor" required>
</div>

<div class="col-md-2">
<input class="form-control" type="number" name="cantidad" placeholder="Cantidad" required>
</div>

<div class="col-md-2">
<input class="form-control" type="number" name="precio" placeholder="Precio" required>
</div>

<div class="col-md-4">
<input class="form-control" type="time" name="hora" required>
</div>

<div class="col-md-12">
<input class="form-control" name="observaciones" placeholder="Observaciones">
</div>

<div class="col-12">
<button class="btn btn-success">Guardar</button>
</div>

</form>

<hr>

<h4>üü° Pedidos Activos</h4>

<table class="table table-bordered text-center">
<tr>
<th>Hora</th>
<th>Cliente</th>
<th>Sabor</th>
<th>Observaciones</th>
<th>Total</th>
<th>Acciones</th>
</tr>

{% for p in pedidos_activos %}
<tr>
<td>{{ p.hora_entrega }}</td>
<td>{{ p.cliente }}</td>
<td>{{ p.sabor }}</td>
<td>{{ p.observaciones }}</td>
<td>${{ "{:,.0f}".format(p.total).replace(",", ".") }}</td>
<td>
<button onclick="mostrarPago({{ p.id }}, {{ p.total }})" class="btn btn-success btn-sm">
Entregar
</button>
</td>
</tr>
{% endfor %}
</table>

<h4 class="mt-5">üü¢ Entregados</h4>

<table class="table table-bordered text-center">
<tr>
<th>Hora</th>
<th>Cliente</th>
<th>Sabor</th>
<th>Observaciones</th>
<th>M√©todo Pago</th>
<th>Total</th>
</tr>

{% for p in pedidos_entregados %}
<tr>
<td>{{ p.hora_entrega }}</td>
<td>{{ p.cliente }}</td>
<td>{{ p.sabor }}</td>
<td>{{ p.observaciones }}</td>
<td>{{ p.metodo_pago }}</td>
<td>${{ "{:,.0f}".format(p.total).replace(",", ".") }}</td>
</tr>
{% endfor %}
</table>

</div>

<!-- MODAL -->
<div class="modal" tabindex="-1" id="modalPago">
  <div class="modal-dialog">
    <div class="modal-content p-3">
      <h5>Forma de Pago</h5>

      <button class="btn btn-outline-success mb-2" onclick="seleccionarPago('Efectivo')">Efectivo</button>
      <button class="btn btn-outline-primary mb-2" onclick="seleccionarPago('Transferencia')">Transferencia</button>

      <div id="efectivoSection" style="display:none;">
          <p>Total: $<span id="totalVenta"></span></p>
          <input type="number" id="efectivoRecibido" class="form-control" placeholder="Efectivo recibido" oninput="calcularVuelto()">
          <p class="mt-2">Vuelto: $<span id="vuelto"></span></p>
      </div>

      <button class="btn btn-success mt-3" onclick="confirmarEntrega()">Confirmar</button>
    </div>
  </div>
</div>

<script>
let pedidoActual = null;
let totalActual = 0;
let metodoSeleccionado = "";

function mostrarPago(id, total) {
    pedidoActual = id;
    totalActual = total;
    document.getElementById("totalVenta").innerText = total;
    document.getElementById("modalPago").style.display = "block";
}

function seleccionarPago(metodo) {
    metodoSeleccionado = metodo;
    if (metodo === "Efectivo") {
        document.getElementById("efectivoSection").style.display = "block";
    } else {
        document.getElementById("efectivoSection").style.display = "none";
    }
}

function calcularVuelto() {
    let recibido = document.getElementById("efectivoRecibido").value;
    let vuelto = recibido - totalActual;
    document.getElementById("vuelto").innerText = vuelto >= 0 ? vuelto : 0;
}

function confirmarEntrega() {
    window.location.href = "/entregar/" + pedidoActual + "?metodo=" + metodoSeleccionado;
}
</script>

</body>
</html>
